---
import BaseHead from "../components/BaseHead.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import { getSession } from "auth-astro/server";
import { getUser } from "@/services/auth";

interface Props {
  title?: string;
  description?: string;
  image?: string;
}

const session = await getSession(Astro.request);

if (!session || !session.user || !session.user.email) {
  return Astro.redirect("/");
}

const user = await getUser(session.user.email, "email");

if (!user || Date.parse(session.expires) < Date.now()) {
  return Astro.redirect("/");
}

const { title, description, image } = Astro.props;
---

<html lang="en">
  <head>
    <BaseHead
      title={title}
      description={description}
      image={image}
    />
  </head>

  <body class="min-h-screen">
    <Header
      user={user}
      server:defer
    />
    <main class="py-20 container">
      <slot />
    </main>
    <Footer />
  </body>
</html>
