---
import { db } from "@/db";
import { likes } from "@/db/schema/likes";
import { and, eq } from "drizzle-orm";

import { getSession } from "auth-astro/server";
import { getUser } from "@/services/auth";
import AddToFavoriteButton from "@/components/react/buttons/AddToFavoriteButton";

interface Props {
  slug: string;
}

const { slug } = Astro.props;
const localsUser = Astro.locals?.user ?? null;
let user = localsUser;

if (!user) {
  const session = await getSession(Astro.request);
  if (session && session.user && session.user.email) {
    user = await getUser(session.user.email, "email");
  }
}

let initialState;

if (user) {
  initialState = await db
    .select()
    .from(likes)
    .where(and(eq(likes.recipeSlug, slug), eq(likes.userId, user.id)))
    .then((res) => res.length > 0);
}
---

{
  user ? (
    <AddToFavoriteButton
      slug={slug}
      initiallyIsLiked={Boolean(initialState)}
      client:only="react"
    />
  ) : null
}
